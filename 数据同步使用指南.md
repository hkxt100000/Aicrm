# 天号城CRM - 数据同步使用指南

## 📋 当前状态说明

您看到的**客户管理**和**通讯录**页面显示空白是**正常的**！

### 原因
- ✅ 系统是全新安装，数据库中没有数据
- ✅ 需要从企业微信同步客户和员工数据
- ✅ 同步功能已经开发完成，只需配置后使用

---

## 🚀 快速开始 - 3步完成数据同步

### 第1步：配置企业微信参数 ⚙️

#### 1.1 点击右上角"⚙️ 配置"按钮
打开企业微信配置弹窗

#### 1.2 填写企业微信信息

您需要准备以下信息：

```
必填项：
├─ 企业ID (CorpID) *
│  获取路径：企业微信管理后台 → 我的企业 → 企业信息
│
├─ 应用 AgentId *
│  获取路径：企业微信管理后台 → 应用管理 → 自建应用 → AgentId
│
└─ 自建应用 Secret * (推荐)
   获取路径：企业微信管理后台 → 应用管理 → 自建应用 → Secret

可选项：
├─ 通讯录 Secret
│  用途：同步员工数据
│
└─ 客户联系 Secret
   用途：同步客户数据
```

#### 1.3 示例配置
```
企业ID：ww1234567890abcdef
应用 AgentId：1000002
自建应用 Secret：Abc123xyz456XYZ789abc123XYZ456
API Token：crm-default-token (默认即可)
```

#### 1.4 保存配置
点击"💾 保存配置"按钮

---

### 第2步：同步员工数据 (通讯录) 👥

#### 2.1 进入通讯录页面
点击左侧导航 → "📇 通讯录"

#### 2.2 点击同步按钮
- 方式1：点击右上角 "🔄 同步通讯录" 按钮
- 方式2：点击页面中央 "🔄 立即同步" 按钮

#### 2.3 等待同步完成
- 系统会显示 "正在同步通讯录，请稍候..."
- 同步完成后显示：
  ```
  ✅ 同步成功！新增 XX 个员工
  ```

#### 2.4 查看员工数据
同步完成后，页面会自动显示员工卡片：

```
┌──────────┐ ┌──────────┐ ┌──────────┐
│ 👤 张三   │ │ 👤 李四   │ │ 👤 王五   │
│ 技术部    │ │ 销售部    │ │ 运营部    │
│ 📱 手机号 │ │ 📱 手机号 │ │ 📱 手机号 │
│ 📧 邮箱   │ │ 📧 邮箱   │ │ 📧 邮箱   │
│ ✅ 已激活 │ │ ✅ 已激活 │ │ ✅ 已激活 │
└──────────┘ └──────────┘ └──────────┘
```

---

### 第3步：同步客户数据 (客户管理) 👨‍💼

#### 3.1 进入客户管理页面
点击左侧导航 → "👥 客户管理"

#### 3.2 点击同步按钮
- 方式1：点击右上角 "🔄 同步客户" 按钮
- 方式2：点击页面中央 "🔄 立即同步" 按钮

#### 3.3 等待同步完成
- 系统会显示 "正在同步客户数据，请稍候..."
- 同步完成后显示：
  ```
  ✅ 同步成功！新增 XX 个客户
  ```

#### 3.4 查看客户数据
同步完成后，页面会显示客户列表表格：

```
┌───────────────────────────────────────┐
│ ☐ | 客户信息 | 员工 | 性别 | 标签 | ... │
├───────────────────────────────────────┤
│ ☐ | 张三     | 李四 | 男   | VIP  | ... │
│ ☐ | 王五     | 赵六 | 女   | 新客 | ... │
│ ...                                   │
└───────────────────────────────────────┘
```

---

## 🔧 常见问题排查

### Q1: 点击同步按钮无响应？
**A**: 检查以下几点：
1. 是否已保存企业微信配置？
2. 打开浏览器控制台（F12）查看错误信息
3. 检查网络连接

### Q2: 同步失败，提示"invalid corpid"？
**A**: 企业ID填写错误
- 重新检查企业微信管理后台的企业ID
- 注意：企业ID通常以 `ww` 开头

### Q3: 同步失败，提示"access_token invalid"？
**A**: Secret填写错误或已过期
- 检查应用Secret是否正确
- 重新获取Secret并保存

### Q4: 同步成功但没有数据？
**A**: 可能原因：
- 企业微信中确实没有客户/员工数据
- Secret权限不足（需要管理员权限）

### Q5: 同步的数据不完整？
**A**: 检查应用权限：
- 客户联系Secret：需要"客户联系"权限
- 通讯录Secret：需要"通讯录管理"权限

---

## 📊 同步功能说明

### 员工同步（通讯录）

**同步内容**:
- ✅ 员工姓名
- ✅ 头像
- ✅ 手机号
- ✅ 邮箱
- ✅ 所属部门
- ✅ 职位
- ✅ 状态（已激活/已禁用/未激活/已退出）

**同步逻辑**:
- 首次同步：插入所有员工
- 再次同步：更新已有员工，插入新员工

**API端点**: `POST /api/sync/employees`

### 客户同步（客户管理）

**同步内容**:
- ✅ 客户姓名
- ✅ 头像
- ✅ 性别
- ✅ 类型（微信用户/企业用户）
- ✅ 企业名称
- ✅ 添加员工
- ✅ 添加时间
- ✅ 标签
- ✅ 备注

**同步逻辑**:
- 首次同步：插入所有客户
- 再次同步：更新已有客户，插入新客户

**API端点**: `POST /api/sync/customers`

---

## 🎯 测试数据同步

### 测试前准备
1. ✅ 确保企业微信中有员工数据
2. ✅ 确保企业微信中有客户数据
3. ✅ 确保配置信息正确

### 测试步骤

#### Step 1: 测试通讯录同步
```bash
# 访问系统
http://localhost:9999/

# 操作
1. 点击"⚙️ 配置"按钮
2. 填写企业微信信息
3. 保存配置
4. 点击"通讯录"
5. 点击"同步通讯录"
6. 等待5-10秒
7. 查看是否显示员工卡片
```

**预期结果**:
- ✅ 显示"同步成功"提示
- ✅ 页面显示员工卡片
- ✅ 员工信息完整（姓名/部门/手机/邮箱）

#### Step 2: 测试客户同步
```bash
# 操作
1. 点击"客户管理"
2. 点击"同步客户"
3. 等待5-10秒
4. 查看是否显示客户列表
```

**预期结果**:
- ✅ 显示"同步成功"提示
- ✅ 页面显示客户列表表格
- ✅ 客户信息完整（姓名/性别/标签等）

---

## 📸 操作截图示例

### 1. 配置企业微信
```
┌─────────────────────────────┐
│ ⚙️ 企业微信配置            ✕ │
├─────────────────────────────┤
│ 企业ID：[ww123456789]       │
│ 应用AgentId：[1000002]      │
│ 应用Secret：[Abc123...]     │
│ ...                         │
│                             │
│        [取消] [💾 保存配置]  │
└─────────────────────────────┘
```

### 2. 同步通讯录
```
┌─────────────────────────────┐
│ 📇 通讯录管理               │
│          [🔄 同步通讯录]     │
├─────────────────────────────┤
│                             │
│ 正在同步通讯录，请稍候...   │
│        ⏳                   │
│                             │
└─────────────────────────────┘

↓ 同步完成后 ↓

┌─────────────────────────────┐
│ 📇 通讯录管理               │
│          [🔄 同步通讯录]     │
├─────────────────────────────┤
│ [张三] [李四] [王五] [赵六] │
│ 技术部  销售部  运营部  ...  │
│ ...                         │
└─────────────────────────────┘
```

### 3. 同步客户
```
┌─────────────────────────────┐
│ 👥 客户管理                 │
│       [🔄 同步客户] [导出]   │
├─────────────────────────────┤
│ 客户姓名 | 员工 | 性别 | ... │
│ 张三     | 李四 | 男   | ... │
│ 王五     | 赵六 | 女   | ... │
│ ...                         │
└─────────────────────────────┘
```

---

## 💡 使用建议

### 同步频率建议
- **首次使用**: 立即同步（获取所有数据）
- **日常使用**: 
  - 员工变动时：手动同步通讯录
  - 新增客户时：手动同步客户
  - 定期同步：每周1次（保持数据最新）

### 性能优化
- 大量数据同步可能需要较长时间
- 建议在非高峰期进行同步
- 首次同步后，增量同步会更快

### 数据安全
- ✅ 所有数据存储在本地数据库
- ✅ 不会上传到第三方服务器
- ✅ 企业微信配置加密存储

---

## 🎉 总结

### 核心要点
1. ⚙️ **配置企业微信参数** - 必须先完成
2. 🔄 **同步员工数据** - 填充通讯录
3. 🔄 **同步客户数据** - 填充客户管理

### 预期效果
- ✅ 通讯录显示所有企业员工
- ✅ 客户管理显示所有客户联系人
- ✅ 数据实时同步，保持最新

### 下一步
完成数据同步后，您可以：
- 📊 使用筛选功能快速查找员工/客户
- 🔍 使用搜索功能精确定位
- 📤 导出数据到Excel或企业微信表格
- 📈 查看客户统计和分析

---

**如有问题，请查看浏览器控制台（F12）的错误信息，或联系技术支持。** 💬

**文档更新**: 2026-01-24  
**版本**: v1.0
