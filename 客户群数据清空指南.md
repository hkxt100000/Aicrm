# 客户群数据清空与重新同步指南

## 📋 问题回顾

当前客户群列表显示的数据有问题：
- ❌ **外部客户列**：全部显示 0（应该显示实际数量）
- ❌ **内部员工列**：全部显示 0（应该显示实际数量）
- ❌ **群公告列**：显示错误内容（应该显示群公告文本）
- ❌ **群类型列**：可能显示不正确
- ✅ **总人数列**：显示正确

---

## 🎯 解决方案：清空数据并重新同步

### **根本原因**
旧数据是用有问题的代码同步的，导致字段映射错误。需要：
1. 清空旧数据
2. 用修复后的代码重新同步

### **修复内容**
已完成以下修复：
1. ✅ 修复死锁问题（`_update_task` 调用移到锁外）
2. ✅ 优化并发性能（从1线程 → 10线程）
3. ✅ 修复 Token 优先级（app → customer）
4. ✅ 优化 API 调用（`need_name=False`，不调用 `_get_user_name`）

---

## 📝 操作步骤

### **步骤1：清空客户群数据**

#### 方式A：使用批处理文件（推荐）
```bash
进入目录：D:\tianhao-webhook\wecom-crm\backend
双击运行：清空客户群数据.bat
```

#### 方式B：使用 Python 脚本
```bash
cd D:\tianhao-webhook\wecom-crm\backend
python clear_customer_groups.py
```

**预期输出：**
```
============================================================
清空客户群数据库
============================================================
数据库路径: D:\tianhao-webhook\wecom-crm\backend\wecom_crm.db
⚠️  注意: 此操作只会清空 customer_groups 表，不影响其他表
============================================================

📊 当前客户群数量: 1398

⚠️  即将删除 1398 条客户群数据
确认删除？(yes/no): 
```

**重要：输入 `yes` 确认删除**

删除完成后会显示：
```
✅ 成功删除 1398 条客户群数据
✅ customer_groups 表已清空
```

---

### **步骤2：验证修复文件是否已更新**

在 `D:\tianhao-webhook\wecom-crm\backend` 目录下执行：

#### 验证 sync_service.py（10并发）
```bash
findstr "ThreadPoolExecutor(max_workers=10)" sync_service.py
```

**预期输出：**
```
with ThreadPoolExecutor(max_workers=10) as executor:
```

如果没有输出，说明文件没有更新！

#### 验证 wecom_client.py（Token优先级）
```bash
findstr "self.get_access_token(\"app\") or self.get_access_token(\"customer\")" wecom_client.py
```

**预期输出：**
```
access_token = self.get_access_token("app") or self.get_access_token("customer")
```

---

### **步骤3：重启服务**

#### 方式A：使用批处理文件
```bash
双击运行：启动服务.bat
```

#### 方式B：手动重启
```bash
# 1. 停止所有Python进程
taskkill /F /IM python.exe

# 2. 进入后端目录
cd D:\tianhao-webhook\wecom-crm\backend

# 3. 清理Python缓存
rmdir /s /q __pycache__
del /s /q *.pyc

# 4. 启动服务
python start.py
```

**预期输出：**
```
🔄 初始化同步服务...
📊 最大并发数: 10
✅ 同步服务初始化完成

INFO:     Started server process [进程ID]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:9999 (Press CTRL+C to quit)
```

---

### **步骤4：重新同步客户群**

1. **打开浏览器**
   ```
   http://localhost:9999
   ```

2. **进入客户群管理**
   - 点击左侧菜单：**客户群管理**
   - 点击：**客户群列表**

3. **开始同步**
   - 点击：**同步群聊** 按钮

4. **观察后台日志**
   
   应该看到类似输出：
   ```
   [客户群同步] 开始同步客户群
   [步骤1] 获取客户群ID列表...
   [客户群列表] 第 1 页，获取 1000 个群
   [客户群列表] 第 2 页，获取 398 个群
   共获取到 1398 个客户群ID
   
   [步骤2] 1398 个群，开始获取详情...
   [同步策略] 使用10线程并发处理
   
   [客户群详情] 开始获取: wrq58..., need_name=0
   [客户群详情] API响应: errcode=0, errmsg=ok
   [客户群详情] 获取成功: XX群, 成员数=6
   
   [进度] 10/1398 (10%) - 新增:10, 更新:0, 失败:0
   [进度] 20/1398 (11%) - 新增:20, 更新:0, 失败:0
   [进度] 30/1398 (12%) - 新增:30, 更新:0, 失败:0
   ...
   [进度] 1390/1398 (99%) - 新增:1390, 更新:0, 失败:0
   
   ✅ 客户群同步完成: 共1398个, 新增1398, 更新0, 失败0
   ```

5. **预计完成时间**
   - 10个线程并发
   - 1398个群 / 10 = 约140轮
   - 每轮约2-3秒
   - **总计：约 4-5 分钟**

---

### **步骤5：验证同步结果**

同步完成后，在浏览器中查看客户群列表：

#### ✅ 正确的显示应该是：

| 序号 | 群名称 | 群ID | 群主 | **总人数** | **外部客户** | **内部员工** | **群公告** | **群类型** | **群状态** |
|------|--------|------|------|------------|--------------|--------------|------------|------------|------------|
| 1 | H01 鼎天莱... | wrq58... | 张三 | 6 | **4** ✅ | **2** ✅ | 欢迎加入... ✅ | 外部群 ✅ | 正常 ✅ |
| 2 | XX销售群 | wrq59... | 李四 | 90 | **85** ✅ | **5** ✅ | 本群用于... ✅ | 外部群 ✅ | 正常 ✅ |

#### ❌ 之前错误的显示：

| 序号 | 群名称 | 群ID | 群主 | 总人数 | **外部客户** | **内部员工** | **群公告** | 群类型 | 群状态 |
|------|--------|------|------|--------|--------------|--------------|------------|--------|--------|
| 1 | H01 鼎天莱... | wrq58... | 张三 | 6 | **0** ❌ | **0** ❌ | external ❌ | - | - |

---

## 📸 请提供以下截图：

1. ✅ **清空数据的输出**（显示 "成功删除 XXX 条客户群数据"）
2. ✅ **文件验证结果**（findstr 命令的输出）
3. ✅ **服务启动日志**（显示 "Application startup complete"）
4. ✅ **同步进度日志**（显示进度百分比）
5. ✅ **同步完成后的客户群列表界面**（验证字段是否正确）

---

## 🚨 如果遇到问题

### 问题1：清空数据时找不到文件
```bash
python: can't open file 'clear_customer_groups.py': [Errno 2] No such file or directory
```

**解决：** 确保你在正确的目录下：
```bash
cd D:\tianhao-webhook\wecom-crm\backend
dir clear_customer_groups.py
```

### 问题2：文件验证没有输出
说明文件没有更新，需要手动替换文件。

### 问题3：同步卡住不动
查看后台日志最后一行，并截图发给我。

---

**现在请开始执行步骤1：清空客户群数据！** 🚀

执行后请把输出截图发给我。
