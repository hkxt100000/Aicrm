// ========== å…¨å±€å˜é‡ ==========
let currentPage = 1;
let totalPages = 1;
let totalCount = 0;
let pageLimit = 20;
let selectedCustomers = [];
let apiToken = localStorage.getItem('api_token') || 'crm-default-token';

// ========== é¡µé¢åŠ è½½ ==========
document.addEventListener('DOMContentLoaded', () => {
    console.log('[åˆå§‹åŒ–] é¡µé¢åŠ è½½å®Œæˆ');
    
    // åŠ è½½é…ç½®
    loadConfig();
    
    // åŠ è½½å‘˜å·¥åˆ—è¡¨
    loadEmployees();
    
    // åŠ è½½æ ‡ç­¾åˆ—è¡¨
    loadTags();
    
    // åŠ è½½å®¢æˆ·åˆ—è¡¨
    loadCustomers();
    
    // å¯¼èˆªåˆ‡æ¢
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const module = item.dataset.module;
            switchModule(module);
        });
    });
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®š"ä¸Šä¼  Excel"æŒ‰é’®ï¼ˆé‡è¦ï¼ï¼‰
    // è¿™æ ·å³ä½¿æŒ‰é’®åœ¨æ¨¡å—åˆ‡æ¢æ—¶è¢«é‡æ–°æ¸²æŸ“ï¼Œäº‹ä»¶ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
    document.body.addEventListener('click', (e) => {
        // æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯ä¸Šä¼ æŒ‰é’®
        const btn = e.target.closest('#btn-upload-excel');
        if (btn) {
            console.log('[äº‹ä»¶] ä¸Šä¼ æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆé€šè¿‡äº‹ä»¶å§”æ‰˜ï¼‰');
            e.preventDefault();
            e.stopPropagation();
            showUploadExcelDialog();
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰‹å·¥åˆ›å»ºè¡¨æ ¼æŒ‰é’®
        const createBtn = e.target.closest('#btn-create-table');
        if (createBtn) {
            console.log('[äº‹ä»¶] æ‰‹å·¥åˆ›å»ºè¡¨æ ¼æŒ‰é’®è¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            showCreateTableDialog();
        }
    });
    
    console.log('[åˆå§‹åŒ–] äº‹ä»¶å§”æ‰˜å·²è®¾ç½®');
});

// ========== æ¨¡å—åˆ‡æ¢ ==========
function switchModule(moduleName) {
    // æ›´æ–°å¯¼èˆªçŠ¶æ€
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.module === moduleName) {
            item.classList.add('active');
        }
    });
    
    // æ›´æ–°å†…å®¹æ˜¾ç¤º
    document.querySelectorAll('.module').forEach(module => {
        module.classList.remove('active');
    });
    document.getElementById(`module-${moduleName}`).classList.add('active');
    
    // å¦‚æœæ˜¯å®¢æˆ·æ¨¡å—ï¼Œé‡æ–°åŠ è½½æ•°æ®
    if (moduleName === 'customers') {
        loadCustomers();
    }
}

// ========== Toast æç¤º ==========
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// ========== é…ç½®ç®¡ç† ==========
function showConfig() {
    const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
    
    document.getElementById('config-corpid').value = config.corpid || '';
    document.getElementById('config-contact-secret').value = config.contact_secret || '';
    document.getElementById('config-app-secret').value = config.app_secret || '';
    document.getElementById('config-customer-secret').value = config.customer_secret || '';
    document.getElementById('config-agentid').value = config.agentid || '';
    document.getElementById('config-api-token').value = apiToken;
    
    document.getElementById('config-modal').classList.add('show');
}

function closeConfig() {
    document.getElementById('config-modal').classList.remove('show');
}

function saveConfig() {
    const config = {
        corpid: document.getElementById('config-corpid').value,
        contact_secret: document.getElementById('config-contact-secret').value,
        app_secret: document.getElementById('config-app-secret').value,
        customer_secret: document.getElementById('config-customer-secret').value,
        agentid: document.getElementById('config-agentid').value
    };
    
    const token = document.getElementById('config-api-token').value;
    
    // ä¼ä¸š ID å¿…å¡«ï¼Œè‡³å°‘è¦æœ‰ä¸€ä¸ª Secret
    if (!config.corpid) {
        showToast('è¯·å¡«å†™ä¼ä¸š ID', 'error');
        return;
    }
    
    if (!config.contact_secret && !config.app_secret && !config.customer_secret) {
        showToast('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ª Secretï¼ˆæ¨èå¡«å†™è‡ªå»ºåº”ç”¨ Secretï¼‰', 'error');
        return;
    }
    
    localStorage.setItem('wecom_config', JSON.stringify(config));
    localStorage.setItem('api_token', token);
    apiToken = token;
    
    showToast('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
    closeConfig();
}

function loadConfig() {
    const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
    console.log('[é…ç½®] å·²åŠ è½½é…ç½®', config);
}

// ========== åŒæ­¥æ•°æ® ==========
async function syncData() {
    showToast('æ­£åœ¨åŒæ­¥æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
    
    // è¯»å–é…ç½®
    const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
    console.log('[åŒæ­¥] ä½¿ç”¨é…ç½®', config);
    
    try {
        // 1. åŒæ­¥å‘˜å·¥
        const employeeRes = await fetch(`/api/sync/employees?api_token=${apiToken}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({config: config})
        });
        const employeeData = await employeeRes.json();
        console.log('[åŒæ­¥] å‘˜å·¥æ•°æ®', employeeData);
        
        // 2. åŒæ­¥æ ‡ç­¾
        const tagRes = await fetch(`/api/sync/tags?api_token=${apiToken}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({config: config})
        });
        const tagData = await tagRes.json();
        console.log('[åŒæ­¥] æ ‡ç­¾æ•°æ®', tagData);
        
        // 3. åŒæ­¥å®¢æˆ·
        const customerRes = await fetch(`/api/sync/customers?api_token=${apiToken}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({force: false, config: config})
        });
        const customerData = await customerRes.json();
        console.log('[åŒæ­¥] å®¢æˆ·æ•°æ®', customerData);
        
        if (customerData.success) {
            showToast(`åŒæ­¥æˆåŠŸï¼å…±åŒæ­¥ ${customerData.count} ä¸ªå®¢æˆ·`, 'success');
            
            // é‡æ–°åŠ è½½æ•°æ®
            loadEmployees();
            loadTags();
            loadCustomers();
        } else {
            showToast(`åŒæ­¥å¤±è´¥ï¼š${customerData.message}`, 'error');
        }
        
    } catch (error) {
        console.error('[åŒæ­¥] å¼‚å¸¸', error);
        showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä¼ä¸šå¾®ä¿¡é…ç½®', 'error');
    }
}

// ========== åŠ è½½å‘˜å·¥åˆ—è¡¨ ==========
async function loadEmployees() {
    try {
        const res = await fetch(`/api/employees?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            const select = document.getElementById('filter-employee');
            select.innerHTML = '<option value="">å…¨éƒ¨å‘˜å·¥</option>';
            
            data.data.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                select.appendChild(option);
            });
            
            console.log('[å‘˜å·¥] åŠ è½½æˆåŠŸ', data.data.length);
        }
    } catch (error) {
        console.error('[å‘˜å·¥] åŠ è½½å¤±è´¥', error);
    }
}

// ========== åŠ è½½æ ‡ç­¾åˆ—è¡¨ ==========
async function loadTags() {
    try {
        const res = await fetch(`/api/tags?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            const select = document.getElementById('filter-tag');
            select.innerHTML = '<option value="">é€‰æ‹©ä¼ä¸šæ ‡ç­¾</option>';
            
            data.data.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = `${tag.group_name} - ${tag.name}`;
                select.appendChild(option);
            });
            
            console.log('[æ ‡ç­¾] åŠ è½½æˆåŠŸ', data.data.length);
        }
    } catch (error) {
        console.error('[æ ‡ç­¾] åŠ è½½å¤±è´¥', error);
    }
}

// ========== åŠ è½½å®¢æˆ·åˆ—è¡¨ ==========
async function loadCustomers() {
    try {
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams({
            api_token: apiToken,
            page: currentPage,
            limit: pageLimit
        });
        
        // æ·»åŠ ç­›é€‰æ¡ä»¶
        const filterEmployee = document.getElementById('filter-employee')?.value;
        const filterFollowStatus = document.getElementById('filter-follow-status')?.value;
        const filterStage = document.getElementById('filter-stage')?.value;
        const filterSearch = document.getElementById('filter-search')?.value;
        
        if (filterEmployee) params.append('owner_userid', filterEmployee);
        if (filterFollowStatus) params.append('follow_status', filterFollowStatus);
        if (filterStage) params.append('stage', filterStage);
        if (filterSearch) params.append('search', filterSearch);
        
        const res = await fetch(`/api/customers?${params.toString()}`);
        const data = await res.json();
        
        if (data.success) {
            renderCustomers(data.data);
            updatePagination(data.total, data.page, data.limit);
            console.log('[å®¢æˆ·] åŠ è½½æˆåŠŸ', data.data.length);
        }
    } catch (error) {
        console.error('[å®¢æˆ·] åŠ è½½å¤±è´¥', error);
        showToast('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥', 'error');
    }
}

// ========== æ¸²æŸ“å®¢æˆ·åˆ—è¡¨ ==========
function renderCustomers(customers) {
    const tbody = document.getElementById('customer-table-body');
    
    if (customers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px;"></i><br>
                    æš‚æ— å®¢æˆ·æ•°æ®<br>
                    <button class="btn-primary" onclick="syncData()" style="margin-top: 10px;">
                        <i class="fas fa-sync-alt"></i> ç«‹å³åŒæ­¥
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = customers.map(customer => {
        const tags = customer.tags || [];
        const genderText = customer.gender === 1 ? 'ç”·' : customer.gender === 2 ? 'å¥³' : 'æœªçŸ¥';
        const genderClass = customer.gender === 1 ? 'badge-male' : customer.gender === 2 ? 'badge-female' : 'badge-unknown';
        const addTime = customer.add_time ? new Date(customer.add_time * 1000).toLocaleString('zh-CN') : '-';
        
        const statusClass = {
            'æœªè·Ÿè¿›': 'status-unfollow',
            'è·Ÿè¿›ä¸­': 'status-following',
            'å·²æˆäº¤': 'status-success',
            'å·²æµå¤±': 'status-lost'
        }[customer.follow_status] || 'status-unfollow';
        
        return `
            <tr>
                <td><input type="checkbox" class="customer-checkbox" value="${customer.id}"></td>
                <td>
                    <div class="customer-info">
                        <img src="${customer.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2245%22 height=%2245%22%3E%3Crect fill=%22%23ddd%22 width=%2245%22 height=%2245%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2216%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eå¤´åƒ%3C/text%3E%3C/svg%3E'}" 
                             alt="${customer.name}" 
                             class="customer-avatar"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2245%22 height=%2245%22%3E%3Crect fill=%22%23ddd%22 width=%2245%22 height=%2245%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2216%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eå¤´åƒ%3C/text%3E%3C/svg%3E'">
                        <div class="customer-details">
                            <span class="customer-name">${customer.name || 'æœªçŸ¥'}</span>
                            <span class="customer-company">${customer.corp_name || 'æš‚æ— ä¼ä¸šä¿¡æ¯'}</span>
                        </div>
                    </div>
                </td>
                <td>${customer.owner_name || '-'}</td>
                <td><span class="badge ${genderClass}">${genderText}</span></td>
                <td>
                    <div class="tag-list">
                        ${tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        ${tags.length > 3 ? `<span class="tag">+${tags.length - 3}</span>` : ''}
                    </div>
                </td>
                <td>-</td>
                <td>${addTime}</td>
                <td><span class="status-badge ${statusClass}">${customer.follow_status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewCustomer('${customer.id}')">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                        <button class="btn-action btn-edit" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
    document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
}

// ========== æ›´æ–°åˆ†é¡µ ==========
function updatePagination(total, page, limit) {
    totalCount = total;
    currentPage = page;
    pageLimit = limit;
    totalPages = Math.ceil(total / limit);
    
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('total-count').textContent = totalCount;
}

// ========== ç¿»é¡µ ==========
function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage < 1 || newPage > totalPages) return;
    
    currentPage = newPage;
    loadCustomers();
}

// ========== ç­›é€‰åŠŸèƒ½ ==========
function applyFilters() {
    currentPage = 1;
    loadCustomers();
}

function resetFilters() {
    document.getElementById('filter-search').value = '';
    document.getElementById('filter-employee').value = '';
    document.getElementById('filter-group').value = '';
    document.getElementById('filter-tag').value = '';
    document.getElementById('filter-date-start').value = '';
    document.getElementById('filter-date-end').value = '';
    document.getElementById('filter-stage').value = '';
    document.getElementById('filter-follow-status').value = '';
    document.getElementById('filter-satisfaction').value = '';
    
    applyFilters();
}

// ========== å…¨é€‰ / å–æ¶ˆå…¨é€‰ ==========
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all').checked;
    document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
        checkbox.checked = selectAll;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.customer-checkbox:checked');
    selectedCustomers = Array.from(checked).map(cb => cb.value);
    document.getElementById('selected-count').textContent = selectedCustomers.length;
}

// ========== æ‰¹é‡æ“ä½œ ==========
function batchUpdateOwner() {
    if (selectedCustomers.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©å®¢æˆ·', 'error');
        return;
    }
    showToast('æ‰¹é‡ä¿®æ”¹è·Ÿè¿›äººåŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function batchUpdateTags() {
    if (selectedCustomers.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©å®¢æˆ·', 'error');
        return;
    }
    showToast('æ‰¹é‡æ‰“æ ‡ç­¾åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function batchSendMessage() {
    if (selectedCustomers.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©å®¢æˆ·', 'error');
        return;
    }
    showToast('ç¾¤å‘æ¶ˆæ¯åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// ========== å®¢æˆ·è¯¦æƒ… ==========
function viewCustomer(customerId) {
    console.log('[æŸ¥çœ‹å®¢æˆ·]', customerId);
    window.location.href = `/static/customer-detail.html?id=${customerId}`;
}

function editCustomer(customerId) {
    console.log('[ç¼–è¾‘å®¢æˆ·]', customerId);
    showToast('ç¼–è¾‘å®¢æˆ·åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function showCustomerDetail(action) {
    showToast('æ·»åŠ å®¢æˆ·åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// ========== å¯¼å‡ºåŠŸèƒ½ ==========
async function exportCustomers() {
    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å®¢æˆ·
    if (selectedCustomers.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å®¢æˆ·', 'warning');
        return;
    }
    
    // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹å¯¹è¯æ¡†
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>å¯¼å‡ºå®¢æˆ·</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">å·²é€‰æ‹© <strong>${selectedCustomers.length}</strong> ä¸ªå®¢æˆ·</p>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">
                        å¯¼å‡ºæ–¹å¼ï¼š
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="exportToExcel()" style="flex: 1;">
                            ğŸ“„ å¯¼å‡ºåˆ° Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportToWeComSpreadsheet()" style="flex: 1;">
                            ğŸ“Š å¯¼å‡ºåˆ°ä¼ä¸šå¾®ä¿¡è¡¨æ ¼
                        </button>
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0; font-size: 14px; color: #1e40af;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong><br>
                        â€¢ Excelï¼šä¸‹è½½åˆ°æœ¬åœ°ï¼Œé€‚åˆç¦»çº¿æŸ¥çœ‹<br>
                        â€¢ ä¼ä¸šå¾®ä¿¡è¡¨æ ¼ï¼šåœ¨çº¿åä½œï¼Œå›¢é˜Ÿå®æ—¶å…±äº«
                    </p>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// å¯¼å‡ºåˆ° Excel
function exportToExcel() {
    showToast('Excel å¯¼å‡ºåŠŸèƒ½å³å°†æ¨å‡º...', 'info');
    document.querySelector('.modal')?.remove();
}

// å¯¼å‡ºåˆ°ä¼ä¸šå¾®ä¿¡è¡¨æ ¼
async function exportToWeComSpreadsheet() {
    const modal = document.querySelector('.modal');
    if (modal) modal.remove();
    
    showToast('æ­£åœ¨åˆ›å»ºä¼ä¸šå¾®ä¿¡è¡¨æ ¼ï¼Œè¯·ç¨å€™...', 'info');
    
    try {
        const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
        
        const res = await fetch(`/api/export/spreadsheet?api_token=${apiToken}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                customer_ids: selectedCustomers,
                doc_name: `å®¢æˆ·åˆ—è¡¨å¯¼å‡º_${new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-')}`,
                admin_users: []  // å¯ä»¥æ·»åŠ ç®¡ç†å‘˜åˆ—è¡¨
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            // æ˜¾ç¤ºæˆåŠŸå¯¹è¯æ¡†
            const successModal = document.createElement('div');
            successModal.className = 'modal active';
            successModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>âœ… å¯¼å‡ºæˆåŠŸ</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‰</div>
                            <p style="font-size: 18px; margin-bottom: 10px;">
                                å·²æˆåŠŸå¯¼å‡º <strong style="color: #8b5cf6;">${data.count}</strong> ä¸ªå®¢æˆ·
                            </p>
                            <p style="color: #666; margin-bottom: 30px;">
                                è¡¨æ ¼å·²åˆ›å»ºï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€æŸ¥çœ‹
                            </p>
                            
                            <a href="${data.url}" target="_blank" class="btn btn-primary" style="display: inline-block; text-decoration: none; padding: 12px 30px; font-size: 16px;">
                                ğŸ“Š æ‰“å¼€ä¼ä¸šå¾®ä¿¡è¡¨æ ¼
                            </a>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; text-align: left;">
                                <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">
                                    <strong>è¡¨æ ¼é“¾æ¥ï¼š</strong>
                                </p>
                                <input type="text" value="${data.url}" readonly 
                                    style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; background: white;"
                                    onclick="this.select(); document.execCommand('copy'); showToast('é“¾æ¥å·²å¤åˆ¶', 'success');">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(successModal);
            
            showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
        } else {
            showToast(`å¯¼å‡ºå¤±è´¥: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('[å¯¼å‡º] é”™è¯¯:', error);
        showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// ========== é€šè®¯å½•æ¨¡å— ==========
let employeesData = [];
let filteredEmployees = [];
let employeePage = 1;
let employeePageLimit = 24;  // æ¯é¡µæ˜¾ç¤º24ä¸ªï¼ˆ4åˆ—x6è¡Œï¼‰

// åŒæ­¥é€šè®¯å½•
async function syncEmployees() {
    showToast('æ­£åœ¨åŒæ­¥é€šè®¯å½•ï¼Œè¯·ç¨å€™...', 'info');
    
    try {
        const res = await fetch(`/api/sync/employees?api_token=${apiToken}`, {
            method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            loadEmployeesList();
        } else {
            showToast(`åŒæ­¥å¤±è´¥ï¼š${data.message}`, 'error');
        }
    } catch (error) {
        console.error('[åŒæ­¥é€šè®¯å½•] å¼‚å¸¸', error);
        showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// åŠ è½½å‘˜å·¥åˆ—è¡¨
async function loadEmployeesList() {
    try {
        const res = await fetch(`/api/employees?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            employeesData = data.data;
            filteredEmployees = employeesData;
            renderEmployees();
            console.log('[é€šè®¯å½•] åŠ è½½æˆåŠŸ', employeesData.length);
        }
    } catch (error) {
        console.error('[é€šè®¯å½•] åŠ è½½å¤±è´¥', error);
        showToast('åŠ è½½é€šè®¯å½•å¤±è´¥', 'error');
    }
}

// æ¸²æŸ“å‘˜å·¥å¡ç‰‡
function renderEmployees() {
    const container = document.getElementById('contacts-list');
    
    if (filteredEmployees.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #999;">
                <i class="fas fa-address-book" style="font-size: 64px; margin-bottom: 20px;"></i><br>
                æš‚æ— å‘˜å·¥æ•°æ®<br>
                <button class="btn-primary" onclick="syncEmployees()" style="margin-top: 20px;">
                    <i class="fas fa-sync-alt"></i> ç«‹å³åŒæ­¥
                </button>
            </div>
        `;
        return;
    }
    
    // åˆ†é¡µ
    const start = (employeePage - 1) * employeePageLimit;
    const end = start + employeePageLimit;
    const pageData = filteredEmployees.slice(start, end);
    
    container.innerHTML = pageData.map(emp => {
        const statusText = {
            1: 'å·²æ¿€æ´»',
            2: 'å·²ç¦ç”¨',
            4: 'æœªæ¿€æ´»',
            5: 'å·²é€€å‡º'
        }[emp.status] || 'æœªçŸ¥';
        
        const statusClass = {
            1: 'status-active',
            2: 'status-disabled',
            4: 'status-inactive',
            5: 'status-quit'
        }[emp.status] || 'status-inactive';
        
        const department = emp.department ? JSON.parse(emp.department).join(', ') : 'æœªåˆ†é…';
        
        return `
            <div class="contact-card" onclick="viewEmployee('${emp.id}')">
                <div class="contact-header">
                    <img src="${emp.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ddd%22 width=%2260%22 height=%2260%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2220%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eå¤´åƒ%3C/text%3E%3C/svg%3E'}" 
                         alt="${emp.name}" 
                         class="contact-avatar"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ddd%22 width=%2260%22 height=%2260%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2220%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eå¤´åƒ%3C/text%3E%3C/svg%3E'">
                    <div class="contact-basic">
                        <div class="contact-name">${emp.name || 'æœªçŸ¥'}</div>
                        <div class="contact-position">${emp.position || 'æš‚æ— èŒä½'}</div>
                    </div>
                </div>
                
                <div class="contact-info">
                    ${emp.mobile ? `
                        <div class="contact-info-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span>${emp.mobile}</span>
                        </div>
                    ` : ''}
                    ${emp.email ? `
                        <div class="contact-info-item">
                            <i class="fas fa-envelope"></i>
                            <span>${emp.email}</span>
                        </div>
                    ` : ''}
                    <div class="contact-info-item">
                        <i class="fas fa-building"></i>
                        <span>${department}</span>
                    </div>
                </div>
                
                <span class="contact-status ${statusClass}">${statusText}</span>
                
                ${emp.customer_count !== undefined ? `
                    <div class="contact-stats">
                        <div class="stat-item">
                            <span class="stat-value">${emp.customer_count || 0}</span>
                            <span class="stat-label">å®¢æˆ·æ•°</span>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    // æ›´æ–°åˆ†é¡µ
    updateEmployeePagination();
}

// æ›´æ–°å‘˜å·¥åˆ†é¡µ
function updateEmployeePagination() {
    const totalPages = Math.ceil(filteredEmployees.length / employeePageLimit);
    document.getElementById('employee-current-page').textContent = employeePage;
    document.getElementById('employee-total-pages').textContent = totalPages;
    document.getElementById('employee-total-count').textContent = filteredEmployees.length;
}

// ç¿»é¡µ
function changeEmployeePage(direction) {
    const totalPages = Math.ceil(filteredEmployees.length / employeePageLimit);
    const newPage = employeePage + direction;
    
    if (newPage < 1 || newPage > totalPages) return;
    
    employeePage = newPage;
    renderEmployees();
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// æœç´¢å‘˜å·¥
function searchEmployees() {
    const keyword = document.getElementById('employee-search').value.toLowerCase();
    const deptFilter = document.getElementById('employee-dept-filter').value;
    const statusFilter = document.getElementById('employee-status-filter').value;
    
    filteredEmployees = employeesData.filter(emp => {
        // å…³é”®è¯æœç´¢
        const matchKeyword = !keyword || 
            emp.name.toLowerCase().includes(keyword) ||
            (emp.mobile && emp.mobile.includes(keyword)) ||
            (emp.email && emp.email.toLowerCase().includes(keyword));
        
        // éƒ¨é—¨ç­›é€‰
        const matchDept = !deptFilter || (emp.department && emp.department.includes(deptFilter));
        
        // çŠ¶æ€ç­›é€‰
        const matchStatus = !statusFilter || emp.status == statusFilter;
        
        return matchKeyword && matchDept && matchStatus;
    });
    
    employeePage = 1;
    renderEmployees();
}

// ç­›é€‰å‘˜å·¥
function filterEmployees() {
    searchEmployees();
}

// æŸ¥çœ‹å‘˜å·¥è¯¦æƒ…
function viewEmployee(employeeId) {
    console.log('[æŸ¥çœ‹å‘˜å·¥]', employeeId);
    showToast('å‘˜å·¥è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// å¯¼å‡ºé€šè®¯å½•
function exportEmployees() {
    showToast('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// åˆå§‹åŒ–æ—¶åŠ è½½é€šè®¯å½•
if (document.getElementById('module-contacts')) {
    loadEmployeesList();
}

// ========== æ™ºèƒ½è¡¨æ ¼æ¨¡å— ==========

let currentSpreadsheetId = null;
let uploadedFileData = null;

// åŠ è½½è¡¨æ ¼åˆ—è¡¨
async function loadSpreadsheetList() {
    try {
        const res = await fetch(`/api/spreadsheet/list?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            renderSpreadsheetList(data.data);
        } else {
            showToast('åŠ è½½è¡¨æ ¼åˆ—è¡¨å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('[æ™ºèƒ½è¡¨æ ¼] åŠ è½½åˆ—è¡¨å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// æ¸²æŸ“è¡¨æ ¼åˆ—è¡¨
function renderSpreadsheetList(spreadsheets) {
    const container = document.getElementById('spreadsheet-list');
    
    if (!spreadsheets || spreadsheets.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #666;">
                <i class="fas fa-table" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                <p style="font-size: 16px;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•è¡¨æ ¼</p>
                <p style="font-size: 14px; margin-top: 10px;">ç‚¹å‡»å³ä¸Šè§’"ä¸Šä¼  Excel"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½è¡¨æ ¼</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = spreadsheets.map(sheet => {
        const createdDate = new Date(sheet.created_at * 1000).toLocaleString('zh-CN');
        const lastSyncDate = sheet.last_sync_at ? new Date(sheet.last_sync_at * 1000).toLocaleString('zh-CN') : 'ä»æœªåŒæ­¥';
        
        return `
            <div class="spreadsheet-card" onclick="viewSpreadsheetDetail('${sheet.id}')">
                <div class="spreadsheet-header">
                    <div class="spreadsheet-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="spreadsheet-info-main">
                        <h3 class="spreadsheet-title">${sheet.name}</h3>
                        <div class="spreadsheet-meta">
                            <span><i class="fas fa-th"></i> ${sheet.col_count} å­—æ®µ</span>
                            <span><i class="fas fa-list"></i> ${sheet.row_count} è¡Œ</span>
                            <span><i class="fas fa-clock"></i> ${createdDate}</span>
                        </div>
                    </div>
                </div>
                <div class="spreadsheet-footer">
                    <span class="last-sync">æœ€ååŒæ­¥: ${lastSyncDate}</span>
                    <div class="spreadsheet-actions" onclick="event.stopPropagation();">
                        <button class="btn-icon" onclick="openSpreadsheetInWecom('${sheet.url}')" title="åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰“å¼€">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <button class="btn-icon" onclick="syncSpreadsheetById('${sheet.id}')" title="åŒæ­¥æ•°æ®">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// æ˜¾ç¤ºä¸Šä¼  Excel å¯¹è¯æ¡†
function showUploadExcelDialog() {
    console.log('[è°ƒè¯•] showUploadExcelDialog è¢«è°ƒç”¨');
    const modal = document.getElementById('upload-excel-modal');
    if (modal) {
        modal.classList.add('show');  // æ”¹ä¸º 'show' è€Œä¸æ˜¯ 'active'
        console.log('[è°ƒè¯•] å¯¹è¯æ¡†å·²æ˜¾ç¤º');
    } else {
        console.error('[è°ƒè¯•] æ‰¾ä¸åˆ° upload-excel-modal å…ƒç´ ');
        return;
    }
    const previewArea = document.getElementById('excel-preview-area');
    if (previewArea) {
        previewArea.style.display = 'none';
    }
    uploadedFileData = null;
}

// å…³é—­ä¸Šä¼ å¯¹è¯æ¡†
function closeUploadExcelDialog() {
    console.log('[è°ƒè¯•] closeUploadExcelDialog è¢«è°ƒç”¨');
    const modal = document.getElementById('upload-excel-modal');
    if (modal) {
        modal.classList.remove('show');  // æ”¹ä¸º 'show' è€Œä¸æ˜¯ 'active'
    }
    const fileInput = document.getElementById('excel-file-input');
    if (fileInput) {
        fileInput.value = '';
    }
    uploadedFileData = null;
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showToast('æ­£åœ¨è§£æ Excel æ–‡ä»¶...', 'info');
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const res = await fetch(`/api/spreadsheet/upload?api_token=${apiToken}`, {
            method: 'POST',
            body: formData
        });
        
        const data = await res.json();
        
        if (data.success) {
            uploadedFileData = data;
            showExcelPreview(data);
            showToast('Excel è§£ææˆåŠŸï¼', 'success');
        } else {
            showToast(`è§£æå¤±è´¥: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('[ä¸Šä¼ ] Excel è§£æå¤±è´¥:', error);
        showToast('è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
    }
}

// æ˜¾ç¤º Excel é¢„è§ˆ
function showExcelPreview(data) {
    document.getElementById('excel-preview-area').style.display = 'block';
    
    // è®¾ç½®é»˜è®¤è¡¨æ ¼åç§°ï¼ˆä½¿ç”¨ç®€å•æ ¼å¼ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ï¼‰
    const now = new Date();
    const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    const filename = data.file_name.replace(/\.[^/.]+$/, '').replace(/[_\-]/g, '');
    document.getElementById('spreadsheet-name').value = `${filename}${timestamp}`;
    
    // æ¸²æŸ“é¢„è§ˆè¡¨æ ¼
    const table = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f9fafb;">
                    ${data.headers.map(h => `<th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">${h}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
                ${data.data.slice(0, 5).map(row => `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        ${row.map(cell => `<td style="padding: 12px;">${cell}</td>`).join('')}
                    </tr>
                `).join('')}
                ${data.row_count > 5 ? `
                    <tr>
                        <td colspan="${data.col_count}" style="padding: 12px; text-align: center; color: #666; font-size: 14px;">
                            ... è¿˜æœ‰ ${data.row_count - 5} è¡Œæ•°æ®
                        </td>
                    </tr>
                ` : ''}
            </tbody>
        </table>
    `;
    
    document.getElementById('excel-preview-table').innerHTML = table;
    document.getElementById('excel-info').innerHTML = `
        æ–‡ä»¶å: ${data.file_name} | å…± ${data.row_count} è¡Œï¼Œ${data.col_count} åˆ—
    `;
}

// ä» Excel åˆ›å»ºè¡¨æ ¼
async function createSpreadsheetFromExcel() {
    if (!uploadedFileData) {
        showToast('è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶', 'warning');
        return;
    }
    
    const name = document.getElementById('spreadsheet-name').value.trim();
    if (!name) {
        showToast('è¯·è¾“å…¥è¡¨æ ¼åç§°', 'warning');
        return;
    }
    
    showToast('æ­£åœ¨åˆ›å»ºä¼ä¸šå¾®ä¿¡è¡¨æ ¼...', 'info');
    
    try {
        // è·å–ä¼ä¸šå¾®ä¿¡é…ç½®
        const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
        
        const fields = uploadedFileData.headers.map(header => ({
            name: header,
            type: uploadedFileData.field_types[header] || 'text'
        }));
        
        const res = await fetch(`/api/spreadsheet/create?api_token=${apiToken}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                fields: fields,
                data: uploadedFileData.data,
                config: config
                // ä¸´æ—¶ç§»é™¤ admin_users æµ‹è¯•
                // admin_users: ['19938885888']
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            // æ ¹æ®æˆåŠŸç±»å‹æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
            if (data.success_type === 'partial' || !data.data_written) {
                // éƒ¨åˆ†æˆåŠŸï¼šè¡¨æ ¼åˆ›å»ºäº†ä½†æ•°æ®æ²¡å†™å…¥
                showToast('è¡¨æ ¼åˆ›å»ºæˆåŠŸï¼', 'success');
                closeUploadExcelDialog();
                loadSpreadsheetList();
                
                // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯å’Œå¯¼å…¥æç¤º
                setTimeout(() => {
                    const message = data.message + '\n\nå»ºè®®ï¼š\n1. ç‚¹å‡»"æ‰“å¼€æŸ¥çœ‹"åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æŸ¥çœ‹è¡¨æ ¼\n2. æ‰‹åŠ¨å¤åˆ¶ç²˜è´´æ•°æ®åˆ°è¡¨æ ¼ä¸­\næˆ–\n3. åœ¨ä¼ä¸šå¾®ä¿¡ä¸­å¯¼å…¥ Excel æ–‡ä»¶\n\næ˜¯å¦ç°åœ¨æ‰“å¼€æŸ¥çœ‹ï¼Ÿ';
                    if (confirm(message)) {
                        window.open(data.url, '_blank');
                    }
                }, 500);
            } else {
                // å®Œå…¨æˆåŠŸï¼šè¡¨æ ¼åˆ›å»ºä¸”æ•°æ®å†™å…¥æˆåŠŸ
                showToast('è¡¨æ ¼åˆ›å»ºæˆåŠŸï¼', 'success');
                closeUploadExcelDialog();
                loadSpreadsheetList();
                
                // â­ æ˜¾ç¤ºä¼˜åŒ–æç¤ºå¼¹çª—
                setTimeout(() => {
                    showOptimizationTip({
                        doc_name: name,
                        url: data.url,
                        field_count: data.field_count || uploadedFileData.headers.length,
                        record_count: data.record_count || uploadedFileData.data.length,
                        empty_columns: data.empty_columns || [],
                        optimization_tip: data.optimization_tip || false
                    });
                }, 500);
            }
        } else {
            // æ£€æŸ¥é…ç½®
            const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
            const hasConfig = config.corpid && (config.app_secret || config.customer_secret || config.contact_secret);
            
            if (data.message && data.message.includes('invalid corpid')) {
                if (hasConfig) {
                    // å·²é…ç½®ä½†ä¼ä¸šIDé”™è¯¯
                    showToast('ä¼ä¸šIDéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¼ä¸šIDæ˜¯å¦æ­£ç¡®', 'error');
                    setTimeout(() => {
                        if (confirm('ä¼ä¸šIDå¯èƒ½æœ‰è¯¯ï¼Œæ˜¯å¦é‡æ–°é…ç½®ï¼Ÿ\n\næç¤ºï¼šè¯·ä»ä¼ä¸šå¾®ä¿¡åå°é‡æ–°å¤åˆ¶ä¼ä¸šID')) {
                            showConfig();
                        }
                    }, 3000);
                } else {
                    // æœªé…ç½®
                    showToast('è¯·å…ˆé…ç½®ä¼ä¸šå¾®ä¿¡å‡­è¯ï¼ç‚¹å‡»å³ä¸Šè§’"é…ç½®"æŒ‰é’®', 'error');
                    setTimeout(() => {
                        if (confirm('æ˜¯å¦ç°åœ¨é…ç½®ä¼ä¸šå¾®ä¿¡å‡­è¯ï¼Ÿ')) {
                            showConfig();
                        }
                    }, 3000);
                }
            } else if (data.message && data.message.includes('access_token missing')) {
                // access_token ç¼ºå¤±
                showToast('è¯·å…ˆé…ç½®ä¼ä¸šå¾®ä¿¡å‡­è¯ï¼ç‚¹å‡»å³ä¸Šè§’"é…ç½®"æŒ‰é’®', 'error');
                setTimeout(() => {
                    if (confirm('æ˜¯å¦ç°åœ¨é…ç½®ä¼ä¸šå¾®ä¿¡å‡­è¯ï¼Ÿ')) {
                        showConfig();
                    }
                }, 3000);
            } else {
                // å…¶ä»–é”™è¯¯
                showToast(`åˆ›å»ºå¤±è´¥: ${data.message}`, 'error');
            }
        }
    } catch (error) {
        console.error('[åˆ›å»ºè¡¨æ ¼] å¤±è´¥:', error);
        showToast('åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// æŸ¥çœ‹è¡¨æ ¼è¯¦æƒ…
async function viewSpreadsheetDetail(spreadsheetId) {
    currentSpreadsheetId = spreadsheetId;
    
    try {
        const res = await fetch(`/api/spreadsheet/${spreadsheetId}?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            showSpreadsheetDetailModal(data.data);
        } else {
            showToast('åŠ è½½è¡¨æ ¼è¯¦æƒ…å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('[è¡¨æ ¼è¯¦æƒ…] åŠ è½½å¤±è´¥:', error);
        showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// æ˜¾ç¤ºè¡¨æ ¼è¯¦æƒ…å¯¹è¯æ¡†
function showSpreadsheetDetailModal(spreadsheet) {
    document.getElementById('spreadsheet-detail-title').textContent = spreadsheet.name;
    
    const createdDate = new Date(spreadsheet.created_at * 1000).toLocaleString('zh-CN');
    const lastSyncDate = spreadsheet.last_sync_at ? new Date(spreadsheet.last_sync_at * 1000).toLocaleString('zh-CN') : 'ä»æœªåŒæ­¥';
    
    const infoHtml = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 20px;">
            <div><strong>è¡¨æ ¼åç§°:</strong> ${spreadsheet.name}</div>
            <div><strong>æ–‡æ¡£ ID:</strong> ${spreadsheet.docid}</div>
            <div><strong>å­—æ®µæ•°é‡:</strong> ${spreadsheet.col_count} ä¸ª</div>
            <div><strong>æ•°æ®è¡Œæ•°:</strong> ${spreadsheet.row_count} è¡Œ</div>
            <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${createdDate}</div>
            <div><strong>æœ€ååŒæ­¥:</strong> ${lastSyncDate}</div>
            <div><strong>ç‰ˆæœ¬:</strong> v${spreadsheet.version}</div>
            <div><strong>çŠ¶æ€:</strong> <span class="badge badge-success">${spreadsheet.status === 'active' ? 'æ­£å¸¸' : 'å·²å½’æ¡£'}</span></div>
        </div>
    `;
    
    document.getElementById('spreadsheet-info').innerHTML = infoHtml;
    
    // æ¸²æŸ“æ•°æ®è¡¨æ ¼
    if (spreadsheet.fields && spreadsheet.fields.length > 0) {
        const headers = spreadsheet.fields.map(f => f.name);
        const tableHtml = `
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9fafb;">
                        ${headers.map(h => `<th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">${h}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${(spreadsheet.data || []).slice(0, 10).map(row => `
                        <tr style="border-bottom: 1px solid #f3f4f6;">
                            ${row.map(cell => `<td style="padding: 12px;">${cell || '-'}</td>`).join('')}
                        </tr>
                    `).join('')}
                    ${spreadsheet.data && spreadsheet.data.length > 10 ? `
                        <tr>
                            <td colspan="${headers.length}" style="padding: 12px; text-align: center; color: #666; font-size: 14px;">
                                ... è¿˜æœ‰ ${spreadsheet.data.length - 10} è¡Œæ•°æ®
                            </td>
                        </tr>
                    ` : ''}
                </tbody>
            </table>
        `;
        document.getElementById('spreadsheet-data-table').innerHTML = tableHtml;
    }
    
    document.getElementById('spreadsheet-detail-modal').classList.add('show');
}

// å…³é—­è¡¨æ ¼è¯¦æƒ…
function closeSpreadsheetDetail() {
    document.getElementById('spreadsheet-detail-modal').classList.remove('show');
    currentSpreadsheetId = null;
}

// åŒæ­¥è¡¨æ ¼æ•°æ®
async function syncSpreadsheet() {
    if (!currentSpreadsheetId) return;
    
    showToast('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
    
    try {
        // è·å–ä¼ä¸šå¾®ä¿¡é…ç½®
        const config = JSON.parse(localStorage.getItem('wecom_config') || '{}');
        
        const res = await fetch(`/api/spreadsheet/${currentSpreadsheetId}/sync?api_token=${apiToken}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                config: config
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            if (data.changed) {
                showToast(`åŒæ­¥æˆåŠŸï¼æ›´æ–°äº† ${data.row_count} è¡Œæ•°æ®`, 'success');
                // é‡æ–°åŠ è½½è¯¦æƒ…
                setTimeout(() => {
                    viewSpreadsheetDetail(currentSpreadsheetId);
                }, 1000);
            } else {
                showToast('æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°', 'info');
            }
        } else {
            showToast(`åŒæ­¥å¤±è´¥: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('[åŒæ­¥] å¤±è´¥:', error);
        showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// é€šè¿‡ ID åŒæ­¥è¡¨æ ¼
async function syncSpreadsheetById(spreadsheetId) {
    currentSpreadsheetId = spreadsheetId;
    await syncSpreadsheet();
    loadSpreadsheetList();
}

// åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰“å¼€
function openInWecom() {
    const url = document.getElementById('spreadsheet-info').closest('.modal-body').querySelector('[href]')?.href;
    if (url) {
        window.open(url, '_blank');
    }
}

// æ‰“å¼€ä¼ä¸šå¾®ä¿¡è¡¨æ ¼
function openSpreadsheetInWecom(url) {
    if (url) {
        window.open(url, '_blank');
    } else {
        showToast('è¡¨æ ¼é“¾æ¥ä¸å¯ç”¨', 'warning');
    }
}

// ========== æ‰‹å·¥åˆ›å»ºè¡¨æ ¼åŠŸèƒ½ ==========

// å…¨å±€å˜é‡ï¼šå½“å‰å­—æ®µåˆ—è¡¨
let currentFields = [];
let templateList = [];
let supplierList = [];

// æ˜¾ç¤ºæ‰‹å·¥åˆ›å»ºè¡¨æ ¼å¯¹è¯æ¡†
function showCreateTableDialog() {
    console.log('[åˆ›å»ºè¡¨æ ¼] æ‰“å¼€æ‰‹å·¥åˆ›å»ºå¯¹è¯æ¡†');
    
    // é‡ç½®è¡¨å•
    document.getElementById('table-name').value = '';
    document.getElementById('table-data-type').value = 'order';
    document.getElementById('table-data-scope').value = 'global';
    document.getElementById('supplier-select-group').style.display = 'none';
    currentFields = [];
    updateFieldsList();
    
    // åŠ è½½ä¾›åº”å•†åˆ—è¡¨
    loadSupplierList();
    
    // æ˜¾ç¤ºå¯¹è¯æ¡†
    document.getElementById('create-table-modal').style.display = 'flex';
}

// å…³é—­æ‰‹å·¥åˆ›å»ºè¡¨æ ¼å¯¹è¯æ¡†
function closeCreateTableDialog() {
    document.getElementById('create-table-modal').style.display = 'none';
}

// æ•°æ®ç±»å‹æ”¹å˜
function onDataTypeChange() {
    const dataType = document.getElementById('table-data-type').value;
    console.log('[åˆ›å»ºè¡¨æ ¼] æ•°æ®ç±»å‹æ”¹å˜:', dataType);
}

// æ•°æ®èŒƒå›´æ”¹å˜
function onDataScopeChange() {
    const scope = document.getElementById('table-data-scope').value;
    const supplierGroup = document.getElementById('supplier-select-group');
    
    if (scope === 'supplier') {
        supplierGroup.style.display = 'block';
    } else {
        supplierGroup.style.display = 'none';
    }
}

// åŠ è½½ä¾›åº”å•†åˆ—è¡¨
async function loadSupplierList() {
    try {
        const res = await fetch(`/api/suppliers/list?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            supplierList = data.data;
            
            const select = document.getElementById('table-supplier-code');
            select.innerHTML = supplierList.map(s => 
                `<option value="${s.code}">${s.name}</option>`
            ).join('');
        }
    } catch (error) {
        console.error('[åˆ›å»ºè¡¨æ ¼] åŠ è½½ä¾›åº”å•†åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºæ¨¡æ¿é€‰æ‹©å™¨
async function showTemplateSelector() {
    try {
        const res = await fetch(`/api/templates/list?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            templateList = data.data;
            
            const templateListEl = document.getElementById('template-list');
            templateListEl.innerHTML = templateList.map(t => `
                <div class="template-item" style="padding: 15px; margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;"
                     onclick="selectTemplate('${t.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0;">${t.name}</h4>
                            <p style="margin: 0; font-size: 14px; color: #666;">${t.description || ''}</p>
                        </div>
                        ${t.is_system ? '<span style="background: #8b5cf6; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">ç³»ç»Ÿæ¨¡æ¿</span>' : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('template-selector-modal').style.display = 'flex';
        }
    } catch (error) {
        console.error('[åˆ›å»ºè¡¨æ ¼] åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
        showToast('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
    }
}

// å…³é—­æ¨¡æ¿é€‰æ‹©å™¨
function closeTemplateSelector() {
    document.getElementById('template-selector-modal').style.display = 'none';
}

// é€‰æ‹©æ¨¡æ¿
async function selectTemplate(templateId) {
    try {
        const res = await fetch(`/api/templates/${templateId}?api_token=${apiToken}`);
        const data = await res.json();
        
        if (data.success) {
            // å°†æ¨¡æ¿å­—æ®µæ·»åŠ åˆ°å½“å‰å­—æ®µåˆ—è¡¨
            currentFields = [...data.data.fields];
            
            // è°ƒè¯•ï¼šæ£€æŸ¥å­—æ®µæ˜¯å¦åŒ…å« editable å±æ€§
            console.log('[æ¨¡æ¿å¯¼å…¥] å­—æ®µæ•°é‡:', currentFields.length);
            console.log('[æ¨¡æ¿å¯¼å…¥] å‰3ä¸ªå­—æ®µ:', currentFields.slice(0, 3));
            
            updateFieldsList();
            closeTemplateSelector();
            showToast(`å·²å¯¼å…¥ ${currentFields.length} ä¸ªå­—æ®µ`, 'success');
        }
    } catch (error) {
        console.error('[åˆ›å»ºè¡¨æ ¼] é€‰æ‹©æ¨¡æ¿å¤±è´¥:', error);
        showToast('é€‰æ‹©æ¨¡æ¿å¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºæ·»åŠ å­—æ®µå¯¹è¯æ¡†
function showAddFieldDialog() {
    if (currentFields.length >= 150) {
        showToast('å­—æ®µæ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ150ä¸ªï¼‰', 'warning');
        return;
    }
    
    document.getElementById('field-wecom-name').value = '';
    document.getElementById('field-system-name').value = '';
    document.getElementById('field-type').value = 'text';
    document.getElementById('add-field-modal').style.display = 'flex';
}

// å…³é—­æ·»åŠ å­—æ®µå¯¹è¯æ¡†
function closeAddFieldDialog() {
    document.getElementById('add-field-modal').style.display = 'none';
}

// æ·»åŠ å­—æ®µåˆ°åˆ—è¡¨
function addFieldToList() {
    const wecomName = document.getElementById('field-wecom-name').value.trim();
    const systemName = document.getElementById('field-system-name').value.trim();
    const type = document.getElementById('field-type').value;
    
    if (!wecomName) {
        showToast('è¯·è¾“å…¥å­—æ®µæ˜¾ç¤ºåç§°', 'warning');
        return;
    }
    
    if (!systemName) {
        showToast('è¯·è¾“å…¥ç³»ç»Ÿå­—æ®µå', 'warning');
        return;
    }
    
    // æ£€æŸ¥é‡å¤
    if (currentFields.some(f => f.wecom_name === wecomName)) {
        showToast('å­—æ®µåç§°å·²å­˜åœ¨', 'warning');
        return;
    }
    
    // æ·»åŠ å­—æ®µï¼Œé»˜è®¤ä¸å¯ç¼–è¾‘
    currentFields.push({
        wecom_name: wecomName,
        system_name: systemName,
        type: type,
        editable: false  // é»˜è®¤ä¸å¯ç¼–è¾‘
    });
    
    updateFieldsList();
    closeAddFieldDialog();
    showToast('å­—æ®µæ·»åŠ æˆåŠŸ', 'success');
}

// æ›´æ–°å­—æ®µåˆ—è¡¨æ˜¾ç¤º
function updateFieldsList() {
    const listEl = document.getElementById('fields-list');
    const badge = document.getElementById('field-count-badge');
    
    badge.textContent = `(${currentFields.length}/150)`;
    
    if (currentFields.length === 0) {
        listEl.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #9ca3af;">
                <i class="fas fa-list" style="font-size: 48px; margin-bottom: 10px;"></i>
                <p>è¿˜æ²¡æœ‰å­—æ®µï¼Œè¯·æ·»åŠ æˆ–ä»æ¨¡æ¿å¯¼å…¥</p>
            </div>
        `;
    } else {
        listEl.innerHTML = currentFields.map((field, index) => {
            // å®‰å…¨è·å– editable å±æ€§ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º false
            const editable = field.editable === true;
            const editableIcon = editable ? 'âœï¸' : 'ğŸ”’';
            const editableText = editable ? 'å¯ç¼–è¾‘' : 'åªè¯»';
            const editableColor = editable ? '#10b981' : '#ef4444';
            const editableBg = editable ? '#d1fae5' : '#fee2e2';
            
            return `
            <div class="field-item" style="padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <strong>${field.wecom_name}</strong>
                        <span style="color: #9ca3af;">â†’</span>
                        <span style="color: #666;">${field.system_name}</span>
                        <span style="font-size: 12px; color: #8b5cf6; background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">${field.type}</span>
                        <button onclick="toggleEditable(${index})" style="border: none; background: ${editableBg}; color: ${editableColor}; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500;" title="ç‚¹å‡»åˆ‡æ¢ç¼–è¾‘æƒé™">
                            <span>${editableIcon}</span>
                            <span>${editableText}</span>
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-icon" onclick="moveFieldUp(${index})" ${index === 0 ? 'disabled' : ''} title="ä¸Šç§»">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="btn-icon" onclick="moveFieldDown(${index})" ${index === currentFields.length - 1 ? 'disabled' : ''} title="ä¸‹ç§»">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="btn-icon btn-danger" onclick="removeField(${index})" title="åˆ é™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `}).join('');
    }
}

// ç§»åŠ¨å­—æ®µä½ç½®ï¼ˆä¸Šï¼‰
function moveFieldUp(index) {
    if (index === 0) return;
    [currentFields[index], currentFields[index - 1]] = [currentFields[index - 1], currentFields[index]];
    updateFieldsList();
}

// ç§»åŠ¨å­—æ®µä½ç½®ï¼ˆä¸‹ï¼‰
function moveFieldDown(index) {
    if (index === currentFields.length - 1) return;
    [currentFields[index], currentFields[index + 1]] = [currentFields[index + 1], currentFields[index]];
    updateFieldsList();
}

// åˆ é™¤å­—æ®µ
function removeField(index) {
    currentFields.splice(index, 1);
    updateFieldsList();
}

// åˆ‡æ¢å­—æ®µç¼–è¾‘æƒé™
function toggleEditable(index) {
    if (currentFields[index]) {
        currentFields[index].editable = !currentFields[index].editable;
        updateFieldsList();
        
        const field = currentFields[index];
        const status = field.editable ? 'å¯ç¼–è¾‘' : 'åªè¯»';
        showToast(`å·²å°†"${field.wecom_name}"è®¾ç½®ä¸º${status}`, 'success');
    }
}

// æ‰‹å·¥åˆ›å»ºè¡¨æ ¼
async function createTableManual() {
    const name = document.getElementById('table-name').value.trim();
    const dataType = document.getElementById('table-data-type').value;
    const dataScope = document.getElementById('table-data-scope').value;
    const supplierCode = document.getElementById('table-supplier-code').value;
    
    // éªŒè¯
    if (!name) {
        showToast('è¯·è¾“å…¥è¡¨æ ¼åç§°', 'warning');
        return;
    }
    
    if (currentFields.length === 0) {
        showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå­—æ®µ', 'warning');
        return;
    }
    
    if (dataScope === 'supplier' && !supplierCode) {
        showToast('è¯·é€‰æ‹©ä¾›åº”å•†', 'warning');
        return;
    }
    
    try {
        console.log('[åˆ›å»ºè¡¨æ ¼] å¼€å§‹åˆ›å»º:', name, dataType, dataScope, supplierCode);
        console.log('[åˆ›å»ºè¡¨æ ¼] å­—æ®µæ•°é‡:', currentFields.length);
        console.log('[åˆ›å»ºè¡¨æ ¼] å­—æ®µåˆ—è¡¨:', currentFields);
        
        const wecomConfig = JSON.parse(localStorage.getItem('wecom_config') || '{}');
        
        const requestData = {
            name,
            data_type: dataType,
            data_scope: dataScope,
            supplier_code: dataScope === 'supplier' ? supplierCode : null,
            fields: currentFields,
            config: wecomConfig
        };
        
        const res = await fetch(`/api/spreadsheet/create-manual?api_token=${apiToken}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast('è¡¨æ ¼åˆ›å»ºæˆåŠŸï¼', 'success');
            closeCreateTableDialog();
            
            // åˆ·æ–°è¡¨æ ¼åˆ—è¡¨
            loadSpreadsheetList();
            
            // æ˜¾ç¤ºå­—æ®µæƒé™è¯´æ˜ï¼ˆå¦‚æœæœ‰åªè¯»å­—æ®µï¼‰
            const fieldNote = data.data.field_usage_note;
            if (fieldNote && fieldNote.readonly_count > 0) {
                setTimeout(() => {
                    const noteMsg = `ğŸ“‹ å­—æ®µæƒé™è¯´æ˜ï¼š\n\n` +
                        `â€¢ æ€»å­—æ®µæ•°ï¼š${fieldNote.total_fields}\n` +
                        `â€¢ åªè¯»å­—æ®µï¼š${fieldNote.readonly_count} ä¸ª\n` +
                        `â€¢ å¯ç¼–è¾‘å­—æ®µï¼š${fieldNote.editable_count} ä¸ª\n\n` +
                        `âš ï¸ æç¤ºï¼šç”±äºä¼ä¸šå¾®ä¿¡ API é™åˆ¶ï¼Œæ— æ³•é€šè¿‡æ¥å£è®¾ç½®å­—æ®µä¸ºåªè¯»ã€‚\n` +
                        `è¯·åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰‹åŠ¨é¿å…ç¼–è¾‘æ ‡è®°ä¸º"åªè¯»"çš„å­—æ®µã€‚\n\n` +
                        `åªè¯»å­—æ®µåˆ—è¡¨ï¼ˆå‰10ä¸ªï¼‰ï¼š\n${fieldNote.readonly_fields.slice(0, 10).join('ã€')}`;
                    
                    alert(noteMsg);
                }, 300);
            }
            
            // è¯¢é—®æ˜¯å¦åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰“å¼€
            setTimeout(() => {
                if (confirm('è¡¨æ ¼å·²åˆ›å»ºæˆåŠŸï¼æ˜¯å¦åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰“å¼€æŸ¥çœ‹ï¼Ÿ')) {
                    window.open(data.data.url, '_blank');
                }
            }, fieldNote && fieldNote.readonly_count > 0 ? 1500 : 500);
        } else {
            showToast(`åˆ›å»ºå¤±è´¥ï¼š${data.message}`, 'error');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é…ç½®é—®é¢˜
            if (data.message.includes('invalid corpid') || data.message.includes('access_token')) {
                setTimeout(() => {
                    if (confirm('ä¼ä¸šå¾®ä¿¡é…ç½®å¯èƒ½æœ‰è¯¯ï¼Œæ˜¯å¦é‡æ–°é…ç½®ï¼Ÿ')) {
                        showConfig();
                    }
                }, 500);
            }
        }
    } catch (error) {
        console.error('[åˆ›å»ºè¡¨æ ¼] å¤±è´¥:', error);
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    }
}

// åˆ é™¤è¡¨æ ¼
async function deleteSpreadsheet() {
    if (!currentSpreadsheetId) return;
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨æ ¼å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
    }
    
    try {
        const res = await fetch(`/api/spreadsheet/${currentSpreadsheetId}?api_token=${apiToken}`, {
            method: 'DELETE'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast('è¡¨æ ¼å·²åˆ é™¤', 'success');
            closeSpreadsheetDetail();
            loadSpreadsheetList();
        } else {
            showToast(`åˆ é™¤å¤±è´¥: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('[åˆ é™¤] å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    }
}

// æ¨¡å—åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
document.addEventListener('DOMContentLoaded', () => {
    // ç›‘å¬æ¨¡å—åˆ‡æ¢
    const originalSwitchModule = window.switchModule;
    window.switchModule = function(moduleName) {
        if (originalSwitchModule) {
            originalSwitchModule(moduleName);
        }
        
        // åˆ‡æ¢åˆ°æ™ºèƒ½è¡¨æ ¼æ¨¡å—æ—¶åŠ è½½åˆ—è¡¨
        if (moduleName === 'spreadsheet') {
            loadSpreadsheetList();
        }
    };
});

// ========== ä¼˜åŒ–æç¤ºå¼¹çª— ==========

// æ˜¾ç¤ºä¼˜åŒ–æç¤ºå¼¹çª—
function showOptimizationTip(result) {
    console.log('[ä¼˜åŒ–æç¤º] æ”¶åˆ°ç»“æœ:', result);
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æç¤º
    if (!result.optimization_tip) {
        console.log('[ä¼˜åŒ–æç¤º] æ— éœ€ä¼˜åŒ–æç¤ºï¼Œç›´æ¥æ‰“å¼€è¡¨æ ¼');
        // æ— ç©ºç™½åˆ—ï¼Œç›´æ¥æ‰“å¼€è¡¨æ ¼
        if (result.url && confirm('è¡¨æ ¼å·²åˆ›å»ºå¹¶å†™å…¥æ•°æ®ï¼æ˜¯å¦åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‰“å¼€æŸ¥çœ‹ï¼Ÿ')) {
            window.open(result.url, '_blank');
        }
        return;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†"ä¸å†æç¤º"
    const hideOptimizationTip = localStorage.getItem('hideOptimizationTip');
    if (hideOptimizationTip === 'true') {
        console.log('[ä¼˜åŒ–æç¤º] ç”¨æˆ·é€‰æ‹©äº†ä¸å†æç¤º');
        // ç”¨æˆ·é€‰æ‹©äº†ä¸å†æç¤ºï¼Œç›´æ¥æ‰“å¼€è¡¨æ ¼
        if (result.url) {
            window.open(result.url, '_blank');
        }
        return;
    }
    
    const emptyColumns = result.empty_columns || [];
    const emptyColumnNames = emptyColumns.map(c => c.field_title).join('ã€');
    
    console.log('[ä¼˜åŒ–æç¤º] æ˜¾ç¤ºä¼˜åŒ–å¼¹çª—ï¼Œç©ºç™½åˆ—:', emptyColumnNames);
    
    const modalHtml = `
        <div class="optimization-modal-overlay" onclick="closeOptimizationModal(event)">
            <div class="optimization-modal" onclick="event.stopPropagation()">
                <div class="optimization-modal-header">
                    <h3>ğŸ“Š è¡¨æ ¼å¯¼å…¥æˆåŠŸï¼</h3>
                    <button class="modal-close-btn" onclick="closeOptimizationModal()">&times;</button>
                </div>
                <div class="optimization-modal-body">
                    <div class="info-section">
                        <p><strong>è¡¨æ ¼åç§°:</strong> ${result.doc_name}</p>
                        <p><strong>å­—æ®µæ•°é‡:</strong> ${result.field_count} ä¸ª</p>
                        <p><strong>è®°å½•æ•°é‡:</strong> ${result.record_count} æ¡</p>
                    </div>
                    
                    <div class="tip-box">
                        <h4>ğŸ’¡ ä¼˜åŒ–å»ºè®®</h4>
                        <p>æ£€æµ‹åˆ° <strong>${emptyColumns.length}</strong> ä¸ªç©ºç™½åˆ—(<strong>${emptyColumnNames}</strong>)ï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–ï¼š</p>
                        
                        <div class="optimization-options">
                            <div class="option">
                                <div class="option-header">
                                    <span class="option-number">1</span>
                                    <h5>éšè—ç©ºç™½åˆ—</h5>
                                </div>
                                <ol>
                                    <li>æ‰“å¼€æ™ºèƒ½è¡¨æ ¼</li>
                                    <li>å³é”®ç‚¹å‡»åˆ—æ ‡é¢˜ï¼ˆ<strong>${emptyColumnNames}</strong>ï¼‰</li>
                                    <li>é€‰æ‹© <strong>"éšè—åˆ—"</strong></li>
                                    <li>é‡å¤æ“ä½œéšè—æ‰€æœ‰ç©ºç™½åˆ—</li>
                                </ol>
                            </div>
                            
                            <div class="option">
                                <div class="option-header">
                                    <span class="option-number">2</span>
                                    <h5>è°ƒæ•´åˆ—é¡ºåº</h5>
                                </div>
                                <ol>
                                    <li>æ‰“å¼€æ™ºèƒ½è¡¨æ ¼</li>
                                    <li>ç‚¹å‡»å¹¶æŒ‰ä½åˆ—æ ‡é¢˜</li>
                                    <li>æ‹–åŠ¨åˆ°åˆé€‚çš„ä½ç½®</li>
                                    <li>å°†å¸¸ç”¨åˆ—æ”¾åœ¨å‰é¢</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="tip-note">
                            <strong>ğŸ’¬ æç¤º:</strong> è¿™äº›ç©ºç™½åˆ—æ˜¯ä¼ä¸šå¾®ä¿¡æ™ºèƒ½è¡¨æ ¼çš„é»˜è®¤å­—æ®µï¼Œæ— æ³•é€šè¿‡APIåˆ é™¤ï¼Œä½†ä¸å½±å“æ•°æ®ä½¿ç”¨ã€‚
                        </div>
                    </div>
                    
                    <div class="checkbox-container">
                        <label>
                            <input type="checkbox" id="dontShowAgain">
                            ä¸å†æç¤ºæ­¤ä¼˜åŒ–å»ºè®®
                        </label>
                    </div>
                </div>
                <div class="optimization-modal-footer">
                    <button class="btn-secondary" onclick="closeOptimizationModal()">
                        çŸ¥é“äº†
                    </button>
                    <button class="btn-primary" onclick="openSmartsheetAndClose('${result.url}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        æ‰“å¼€è¡¨æ ¼
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// å…³é—­ä¼˜åŒ–æç¤ºå¼¹çª—
function closeOptimizationModal(event) {
    // å¦‚æœæ˜¯ç‚¹å‡»èƒŒæ™¯å±‚ï¼Œæ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯èƒŒæ™¯è€Œä¸æ˜¯å¼¹çª—å†…å®¹
    if (event && event.target.classList.contains('optimization-modal')) {
        return;
    }
    
    const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
    if (dontShowAgainCheckbox && dontShowAgainCheckbox.checked) {
        localStorage.setItem('hideOptimizationTip', 'true');
        console.log('[ä¼˜åŒ–æç¤º] ç”¨æˆ·é€‰æ‹©äº†ä¸å†æç¤º');
    }
    
    const modal = document.querySelector('.optimization-modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// æ‰“å¼€è¡¨æ ¼å¹¶å…³é—­å¼¹çª—
function openSmartsheetAndClose(url) {
    if (url) {
        window.open(url, '_blank');
    }
    closeOptimizationModal();
}

